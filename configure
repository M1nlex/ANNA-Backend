#! /usr/bin/env bash

export DEBIAN_FRONTEND=noninteractive

# Remove old log
[[ -f /vagrant/vm_build.log ]] && rm /vagrant/vm_build.log

# Put date in provision log
date > /vagrant/vm_build.log

# Variables
DBHOST=localhost
DBNAME=ipsaone
DBUSER=root
DBPASSWD=OneServ_2017

echo -e "\n--- Provisioning OneOS ---"
echo -e "Warning: be patient\n"


echo -e "\n--- Updating packages list ---\n"
apt-get -qy update >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Installing base packages ---\n"
apt-get -qy install curl build-essential git >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Installing NodeJS ---\n"
curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - >> /vagrant/vm_build.log 2>&1
apt-get -qy install nodejs >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Installing Apache ---\n"
apt-get -qy apache2 >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Installing MySQL specific packages and settings ---\n"
debconf-set-selections <<< "mysql-server mysql-server/root_password password $DBPASSWD" >> /vagrant/vm_build.log 2>&1
debconf-set-selections <<< "mysql-server mysql-server/root_password_again password $DBPASSWD" >> /vagrant/vm_build.log 2>&1
debconf-set-selections <<< "phpmyadmin phpmyadmin/dbconfig-install boolean true" >> /vagrant/vm_build.log 2>&1
debconf-set-selections <<< "phpmyadmin phpmyadmin/app-password-confirm password $DBPASSWD" >> /vagrant/vm_build.log 2>&1
debconf-set-selections <<< "phpmyadmin phpmyadmin/mysql/admin-pass password $DBPASSWD" >> /vagrant/vm_build.log 2>&1
debconf-set-selections <<< "phpmyadmin phpmyadmin/mysql/app-pass password $DBPASSWD" >> /vagrant/vm_build.log 2>&1
debconf-set-selections <<< "phpmyadmin phpmyadmin/reconfigure-webserver multiselect none" >> /vagrant/vm_build.log 2>&1
apt-get -qy install mysql-server phpmyadmin >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Setting up our MySQL user and db ---\n"
mysql -u $DBUSER -p$DBPASSWD -e "CREATE DATABASE $DBNAME DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci" >> /vagrant/vm_build.log 2>&1
mysql -u $DBUSER -p$DBPASSWD -e "grant all privileges on $DBNAME.* to '$DBUSER'@'localhost' identified by '$DBPASSWD'" >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Setting up PHPmyAdmin ---\n"
# sudo ln -s /etc/phpmyadmin/apache.conf /etc/apache2/conf-available/phpmyadmin.conf
sudo a2enconf phpmyadmin.conf >> /vagrant/vm_build.log 2>&1
sudo service apache2 reload >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Installing Redis ---\n"
apt-get -qy install redis-server >> /vagrant/vm_build.log 2>&1
cp -f /home/vagrant/Anna/redis.conf /etc/redis/redis.conf >> /vagrant/vm_build.log 2>&1
service redis restart >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Adding ip to hosts ---\n"
echo "192.168.50.5 anna.local.dev" >> /etc/hosts >> /vagrant/vm_build.log 2>&1


echo -e "\n--- Installing dependencies via NPM ---\n"
cd /home/vagrant/Anna
sudo npm install --no-bin-links >> /vagrant/vm_build.log 2>&1

echo -e "\n--- Migrating $DNAME database ---\n"
cd /home/vagrant/Anna
node_modules/.bin/sequelize db:migrate >> /vagrant/vm_build.log 2>&1

echo -e "\n--- Testing setup ---\n"
if hash nodejs 2>/dev/null; then
	echo -e "NodeJS : OK"
	./node_modules/.bin/mocha config/config_test.js
else
	echo -e "NodeJS : failed">&1
fi

echo -e "\n--- OneOS is ready ---"
