language: node_js
node_js:
- 12
services:
- redis-server
deploy:
  skip-cleanup: true,
  provider: script,
  script: "./devops/build.sh"
  on:
    tags: true
    all_branches: true
before_install:
- openssl aes-256-cbc -K $encrypted_f57c64a0b291_key -iv $encrypted_f57c64a0b291_iv
  -in ./travis_deploy_key.enc -out ~/travis_deploy_key -d
- eval "$(ssh-agent -s)"
- chmod 600 ~/travis_deploy_key
- echo -e "Host ipsaone.space\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
- ssh-add ~/travis_deploy_key
- ssh -i ~/travis_deploy_key travis@ipsaone.space pwd

after_success:
- npm install pm2 -g
# Use BASH instead of DASH! see: https://ubuntuforums.org/showthread.php?t=1932504
# - ls -al /bin/sh && sudo rm /bin/sh && sudo ln -s /bin/bash /bin/sh && ls -al /bin/sh
# - if [ $TRAVIS_PULL_REQUEST_BRANCH ]; then
#     sh .bin/deploy.sh;
#   fi
# - sh ./bin/deploy.sh;
- pm2 deploy ecosystem.config.js production update
- pm2 deploy ecosystem.config.js production exec "pm2 reload all"
